#!/bin/bash
# scripts/backup-system.sh
# Updates the existing disaster-pi system image.
# Add to crontab: 0 5 * * 1 /opt/disaster-pi/scripts/backup-system.sh (Mondays at 5am)

set -e

# --- Configuration ---
USB_MOUNT="${1:-/mnt/usb_backup}"
IMAGE_PATH="$USB_MOUNT/disaster-pi-full.img"
LOG_FILE="/opt/disaster-pi/system-backup.log"

# --- Validation ---
if [ ! -f "/usr/local/sbin/image-backup" ]; then
    echo "âŒ image-backup tool not found. Run scripts/setup-image-backup.sh first."
    exit 1
fi

if ! mountpoint -q "$USB_MOUNT"; then
    echo "âŒ USB not mounted at $USB_MOUNT. Aborting."
    exit 1
fi

if [ ! -f "$IMAGE_PATH" ]; then
    echo "âŒ Base image not found at $IMAGE_PATH."
    echo "   Run scripts/setup-image-backup.sh manually to create the initial image."
    exit 1
fi

echo "--- ðŸ’¿ Starting System Image Update: $(date) ---" >> "$LOG_FILE"

# Run the update
# When an image path is provided as an argument, image-backup runs in update mode (rsync)
/usr/local/sbin/image-backup "$IMAGE_PATH" >> "$LOG_FILE" 2>&1

echo "âœ… System Image Updated: $(date)" >> "$LOG_FILE"